name: Lighthouse
description: Audit the provided site with Lighthouse

inputs:
  source:
    description: The site handle to screenshot
    required: true

runs:
  using: "composite"
  steps:
    - id: install
      name: Install Python dependencies
      uses: ./.github/actions/install

    - id: geturl
      name: Get URL
      run: |
        export URL=$(pipenv run python -c "from newshomepages import utils; print(utils.get_site('${{ inputs.source }}')['url'])")
        echo "::set-output name=url::$(echo $URL)"
      shell: bash

    - id: audit
      name: Audit URL
      uses: treosh/lighthouse-ci-action@v9
      with:
        urls: ${{ steps.geturl.outputs.url }}
        runs: 3

    - id: mv
      name: Move report
      run: mv ${{ steps.audit.outputs.resultsPath }}/manifest.json ./${{ inputs.source }}.lighthouse.json
      shell: bash

    - name: Upload results as an artifact
      uses: actions/upload-artifact@master
      with:
        name: lighthouse
        path: ./${{ inputs.source }}.lighthouse.json
