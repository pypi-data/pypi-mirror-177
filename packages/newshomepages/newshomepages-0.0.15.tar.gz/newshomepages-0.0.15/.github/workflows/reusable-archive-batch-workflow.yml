name: "Reusable workflow: Archive batch"

on:
  workflow_call:
    inputs:
      batch:
        description: "The batch number to archive"
        required: true
        type: string

jobs:
  sources:
    name: Sources
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3

      - id: get-site-list
        uses: ./.github/actions/batch
        with:
          command: sites-by-batch ${{ inputs.batch }}
    outputs:
      site-list: ${{ steps.get-site-list.outputs.site-list }}

  jpg:
    name: JPG
    runs-on: ubuntu-20.04
    timeout-minutes: 15
    needs: sources
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        source: ${{ fromJson(needs.sources.outputs.site-list) }}
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3

      - id: screenshot
        name: Screenshot
        uses: ./.github/actions/screenshot
        with:
          source: ${{ matrix.source }}

  accessibility:
    name: a11y
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: sources
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        source: ${{ fromJson(needs.sources.outputs.site-list) }}
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3

      - id: save-page
        name: Save the accessibility tree
        uses: ./.github/actions/accessibility
        with:
          source: ${{ matrix.source }}

  hyperlinks:
    name: Hyperlinks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: sources
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        source: ${{ fromJson(needs.sources.outputs.site-list) }}
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3

      - id: save-page
        name: Save hyperlinks
        uses: ./.github/actions/hyperlinks
        with:
          source: ${{ matrix.source }}

  wayback:
    name: Wayback Machine
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: sources
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        source: ${{ fromJson(needs.sources.outputs.site-list) }}
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3

      - id: save-page
        name: Save in Wayback Machine
        uses: ./.github/actions/wayback
        with:
          source: ${{ matrix.source }}
          access-key: ${{ secrets.IA_ACCESS_KEY }}
          secret-key: ${{ secrets.IA_SECRET_KEY }}

  lighthouse:
    name: Lighthouse audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: sources
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        source: ${{ fromJson(needs.sources.outputs.site-list) }}
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3

      - id: audit
        name: Audit
        uses: ./.github/actions/lighthouse
        with:
          source: ${{ matrix.source }}

  archive:
    name: Post to archive.org
    needs: [jpg,accessibility,hyperlinks,wayback,lighthouse,sources]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        source: ${{ fromJson(needs.sources.outputs.site-list) }}
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3

      - id: archive
        name: Post
        uses: ./.github/actions/archive
        with:
          source: ${{ matrix.source }}
          access-key: ${{ secrets.IA_ACCESS_KEY }}
          secret-key: ${{ secrets.IA_SECRET_KEY }}
          collection: ${{ secrets.IA_COLLECTION }}

  upload:
    name: Upload
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [archive]
    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v3

      - id: upload
        name: Upload
        uses: ./.github/actions/upload
        with:
          artifact: screenshots
          destination: latest-screenshots
          s3-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          s3-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          s3-bucket-name: ${{ secrets.AWS_BUCKET_NAME }}

      - id: install
        name: Install Python dependencies
        uses: ./.github/actions/install

      - id: configure-github
        name: Configure GitHub
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config pull.rebase false
        shell: bash

      - id: git-pull
        name: Git pull
        run: git pull origin main
        shell: bash

      - id: download-items
        name: Download archive.org items
        run: pipenv run python -m newshomepages.extract download-items --batch=${{ inputs.batch }} --output-path=./_dist/
        shell: bash
        env:
          IA_ACCESS_KEY: ${{ secrets.IA_ACCESS_KEY }}
          IA_SECRET_KEY: ${{ secrets.IA_SECRET_KEY }}
          IA_COLLECTION: ${{ secrets.IA_COLLECTION }}

      - id: git-commit-items
        name: Commit archive.org items
        run: |
          git pull origin main
          cp ./_dist/*.json extracts/json/
          git add ./extracts/json
          git commit -m "Update archive.org items" --author="palewire <palewire@users.noreply.github.com>"
          git pull origin main
          git push origin main
        shell: bash

      - id: save
        name: Save artifact
        uses: actions/upload-artifact@v3
        with:
          name: extracts
          path: ./extracts
          if-no-files-found: error

      - id: upload-extract
        name: Upload extracts
        uses: shallwefootball/s3-upload-action@master
        with:
          aws_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_bucket: ${{ secrets.AWS_BUCKET_NAME }}
          source_dir: ./extracts
          destination_dir: extracts
